name: Compile, Test, Build, Publish

on:
  workflow_dispatch:

jobs:
  compile-test:
    strategy:
      matrix:
        os: [ windows-latest, ubuntu-latest, macos-latest ]
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: 'true'

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Run commands
        run: |
          pip install poetry
          poetry config virtualenvs.create false
          poetry install --with dev
          python scripts/compile.py
          pytest

      - name: Upload compiled binaries
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.os }}-binaries
          path: quantcrypt/internal/bin
          retention-days: 1

  build:
    needs: compile-test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all compiled binaries
        uses: actions/download-artifact@v4
        with:
          path: quantcrypt/internal/bin
          merge-multiple: true

      - name: Check merged binaries
        run: |
          ls -R quantcrypt/internal/bin

#      - name: Set up Python
#        uses: actions/setup-python@v5
#        with:
#          python-version: '3.10'
#
#      - name: Run commands
#        run: |
#          pip install poetry
#          poetry build
#
#      - name: Upload built package
#        uses: actions/upload-artifact@v4
#        with:
#          name: package
#          path: dist
#
#  publish:
#    needs: build
#    runs-on: ubuntu-latest
#
#    environment:
#      name: release
#      url: https://pypi.org/project/quantcrypt/
#
#    permissions:
#      id-token: write
#
#    steps:
#      - name: Download package artifact
#        uses: actions/download-artifact@v4
#        with:
#          name: package
#          path: dist
#
#      - name: Publish package to PyPI
#        uses: pypa/gh-action-pypi-publish@release/v1
